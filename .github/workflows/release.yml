name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1
        
      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release
          
      - name: Build
        run: cmake --build build --config Release -j 4
          
      - name: Install & Package
        shell: pwsh
        run: |
          $PkgDir = "avioflow-window-x64"
          if (Test-Path "$PkgDir.zip") { Remove-Item "$PkgDir.zip" }
          cmake --install build --prefix $PkgDir --config Release
          
          # Use editbin (now in PATH thanks to msvc-dev-cmd)
          Write-Host "Stripping debug info using editbin..."
          & editbin /STRIP:DEBUG "$PkgDir/bin/avioflow.dll"
          Get-ChildItem -Path "$PkgDir/bin/*.exe" | ForEach-Object { & editbin /STRIP:DEBUG $_.FullName }
          
          Compress-Archive -Path "$PkgDir/*" -DestinationPath "$PkgDir.zip"

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: avioflow-window-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    runs-on: ubuntu-latest
    container:
      image: quay.io/pypa/manylinux_2_28_x86_64
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          dnf install -y alsa-lib-devel libX11-devel cmake
          
      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release
          
      - name: Build
        run: cmake --build build --config Release -j $(nproc)
          
      - name: Install & Package
        run: |
          PKG_DIR="avioflow-linux-x64"
          rm -rf $PKG_DIR $PKG_DIR.tar.gz
          cmake --install build --prefix $PKG_DIR
          
          # Strip symbols for size and privacy
          # We check if files exist to avoid erroring if some targets were optional
          find $PKG_DIR/lib -name "*.so*" -exec strip --strip-unneeded {} + || true
          find $PKG_DIR/bin -type f -exec strip --strip-unneeded {} + || true
          
          tar -czvf $PKG_DIR.tar.gz $PKG_DIR

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: avioflow-linux-x64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

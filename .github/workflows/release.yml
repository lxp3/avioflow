name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # 1. Build C++ Standalone Binaries (Windows)
  build-cpp-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1
      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_WASAPI=ON -DENABLE_PYTHON=OFF
      - name: Build
        run: cmake --build build --config Release -j 4
      - name: Package
        shell: pwsh
        run: |
          $PkgDir = "avioflow-cpp-win-x64"
          cmake --install build --prefix $PkgDir --config Release
          Compress-Archive -Path "$PkgDir/*" -DestinationPath "$PkgDir.zip"
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: avioflow-cpp-win-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 2. Build C++ Standalone Binaries (Linux)
  build-cpp-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev libx11-dev
      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_WASAPI=ON -DENABLE_PYTHON=OFF
      - name: Build
        run: cmake --build build --config Release -j $(nproc)
      - name: Package
        run: |
          PKG_DIR="avioflow-cpp-linux-x64"
          cmake --install build --prefix $PKG_DIR
          tar -czvf $PKG_DIR.tar.gz $PKG_DIR
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: avioflow-cpp-linux-x64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 3. Build C++ Standalone Binaries (macOS)
  build-cpp-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: brew install ffmpeg
      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_PYTHON=OFF
      - name: Build
        run: cmake --build build --config Release -j $(sysctl -n hw.ncpu)
      - name: Package
        run: |
          PKG_DIR="avioflow-cpp-macos-universal"
          cmake --install build --prefix $PKG_DIR
          tar -czvf $PKG_DIR.tar.gz $PKG_DIR
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: avioflow-cpp-macos-universal.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 4. Build Python Wheels (Multi-platform)
  build-python-wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install ffmpeg

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.22.0
        env:
          # Build only for modern Python
          CIBW_SKIP: "cp36-* cp37-* cp38-* pp*"
          # Linux-specific config (install dependencies in manylinux container)
          CIBW_BEFORE_BUILD_LINUX: "yum install -y alsa-lib-devel libX11-devel"
          # Repair wheels (bundle DLLs/SOs/dylibs)
          CIBW_TEST_COMMAND: "python {project}/avioflow/python/test_audio_load.py {project}/public/TownTheme.mp3"
          
      - uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.os }}-${{ strategy.job-index }}
          path: ./wheelhouse/*.whl

  # 5. Publish to PyPI and GitHub Release
  publish:
    needs: [build-cpp-windows, build-cpp-linux, build-cpp-macos, build-python-wheels]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: cibw-wheels-*
          path: dist
          merge-multiple: true

      - name: Upload Wheels to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.whl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        if: env.PYPI_TOKEN != ''
        env:
          PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        # with:
        #   repository-url: https://test.pypi.org/legacy/ # Uncomment for TestPyPI

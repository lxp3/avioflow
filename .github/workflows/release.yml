name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write # Required for provenance

jobs:
  # ============================================================
  # Linux Build (C++ + Node.js + Python Wheels)
  # ============================================================
  build-linux:
    runs-on: ubuntu-latest
    container: quay.io/pypa/manylinux_2_28_x86_64
    steps:
      - uses: actions/checkout@v4

      - name: Cache System Dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: /var/cache/yum
          key: linux-deps-${{ hashFiles('.github/workflows/release.yml') }}

      - name: Install System Dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          yum install -y epel-release
          yum install -y alsa-lib-devel libX11-devel zlib-devel bzip2-devel xz-devel libva-devel libdrm-devel

      - name: Install Node.js 20
        run: |
          curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
          yum install -y nodejs

      # --- Build C++ Shared Binaries ---
      - name: Build C++ Shared Binaries
        run: |
          cmake -B build_shared \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DENABLE_WASAPI=OFF \
            -DENABLE_PYTHON=OFF \
            -DENABLE_NODE_JS=OFF \
            -DENABLE_BINARY=ON
          cmake --build build_shared --config Release -j $(nproc)

      - name: Package C++ Binaries
        run: |
          PKG_DIR="avioflow-shared-linux-x64"
          cmake --install build_shared --prefix $PKG_DIR
          tar -czvf $PKG_DIR.tar.gz $PKG_DIR

      # --- Build Node.js Addon (Static) ---
      - name: Build Node.js Addon (Static)
        run: |
          npm install
          npx cmake-js compile --CDCMAKE_BUILD_TYPE=Release
          mkdir -p prebuilds/linux-x64
          cp build/bin/avioflow.node prebuilds/linux-x64/avioflow.napi.node

      # --- Upload Artifacts ---
      - uses: actions/upload-artifact@v4
        with:
          name: linux-cpp-binaries
          path: avioflow-shared-linux-x64.tar.gz

      - uses: actions/upload-artifact@v4
        with:
          name: linux-nodejs-prebuilds
          path: prebuilds/

  # --- Build Python Wheels (Linux, Shared) ---
  build-python-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.22.0
        env:
          CIBW_ARCHS_LINUX: x86_64
          CIBW_BUILD: "cp38-* cp39-* cp310-* cp311-* cp312-* cp313-* cp314-*"
          CIBW_SKIP: "pp* *-musllinux*"
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28
          CIBW_BEFORE_BUILD_LINUX: >
            yum install -y epel-release &&
            yum install -y alsa-lib-devel libX11-devel zlib-devel bzip2-devel xz-devel libva-devel libdrm-devel
          CIBW_ENVIRONMENT_LINUX: "CMAKE_ARGS=-DBUILD_SHARED_LIBS=ON"
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: >
            export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(find /project -name "libavformat.so*" -exec dirname {} \; | head -n 1) &&
            auditwheel repair -w {dest_dir} {wheel}
          CIBW_TEST_COMMAND: "python {project}/tests/python/test_audio_load.py {project}/public/wavs/TownTheme.mp3"

      - uses: actions/upload-artifact@v4
        with:
          name: linux-python-wheels
          path: ./wheelhouse/*.whl

  # ============================================================
  # Windows Build (C++ + Node.js + Python Wheels)
  # ============================================================
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # --- Build C++ Shared Binaries ---
      - name: Build C++ Shared Binaries
        shell: pwsh
        run: |
          cmake -B build_shared `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_SHARED_LIBS=ON `
            -DENABLE_WASAPI=ON `
            -DENABLE_PYTHON=OFF `
            -DENABLE_NODE_JS=OFF `
            -DENABLE_BINARY=ON
          cmake --build build_shared --config Release -j 4

      - name: Package C++ Binaries
        shell: pwsh
        run: |
          $PkgDir = "avioflow-shared-win-x64"
          cmake --install build_shared --prefix $PkgDir --config Release
          Compress-Archive -Path "$PkgDir/*" -DestinationPath "$PkgDir.zip"

      # --- Build Node.js Addon (Static) ---
      - name: Build Node.js Addon (Static)
        shell: pwsh
        run: |
          npm install
          npx cmake-js compile
          New-Item -ItemType Directory -Path prebuilds/win32-x64 -Force
          Copy-Item build/bin/Release/avioflow.node prebuilds/win32-x64/avioflow.napi.node

      # --- Upload Artifacts ---
      - uses: actions/upload-artifact@v4
        with:
          name: windows-cpp-binaries
          path: avioflow-shared-win-x64.zip

      - uses: actions/upload-artifact@v4
        with:
          name: windows-nodejs-prebuilds
          path: prebuilds/

  # --- Build Python Wheels (Windows, Shared) ---
  build-python-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.22.0
        env:
          CIBW_ARCHS_WINDOWS: AMD64
          CIBW_BUILD: "cp38-* cp39-* cp310-* cp311-* cp312-* cp313-* cp314-*"
          CIBW_SKIP: "pp* *-win32"
          CIBW_ENVIRONMENT_WINDOWS: "CMAKE_ARGS=-DBUILD_SHARED_LIBS=ON"
          CIBW_TEST_COMMAND: "python {project}/tests/python/test_audio_load.py {project}/public/wavs/TownTheme.mp3"

      - uses: actions/upload-artifact@v4
        with:
          name: windows-python-wheels
          path: ./wheelhouse/*.whl

  # ============================================================
  # Publish to GitHub, PyPI, and NPM
  # ============================================================
  publish:
    needs: [build-linux, build-python-linux, build-windows, build-python-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      # Download all artifacts
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      # Prepare directories
      - name: Prepare release files
        run: |
          mkdir -p dist pypi_dist prebuilds
          # C++ binaries (GitHub Release only)
          cp artifacts/linux-cpp-binaries/* dist/ || true
          cp artifacts/windows-cpp-binaries/* dist/ || true
          # Python wheels (GitHub Release & PyPI)
          cp artifacts/linux-python-wheels/*.whl dist/ || true
          cp artifacts/windows-python-wheels/*.whl dist/ || true
          cp artifacts/linux-python-wheels/*.whl pypi_dist/ || true
          cp artifacts/windows-python-wheels/*.whl pypi_dist/ || true
          # Node.js prebuilds
          cp -r artifacts/linux-nodejs-prebuilds/* prebuilds/ || true
          cp -r artifacts/windows-nodejs-prebuilds/* prebuilds/ || true

      # Upload to GitHub Release
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Publish to PyPI
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: pypi_dist/
          password: ${{ secrets.PYPI_API_TOKEN }}

      # Publish to NPM
      - name: Prepare NPM package
        run: |
          npm install
          ls -la prebuilds/

      - name: Publish to NPM
        run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
